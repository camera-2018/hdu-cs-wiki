name: Update Contributors

on:
  schedule:
    # æ¯å‘¨æ—¥ 00:00 UTC è‡ªåŠ¨è¿è¡Œ
    - cron: '0 0 * * 0'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pull-requests: write

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Fetch contributors from GitHub API
        id: fetch-contributors
        run: |
          # èŽ·å–è´¡çŒ®è€…æ•°æ®
          contributors_json=$(curl -s "https://api.github.com/repos/${{ github.repository }}/contributors?per_page=100")
          
          # è¿‡æ»¤æŽ‰æœºå™¨äººè´¦æˆ·ï¼Œåªä¿ç•™è´¡çŒ®æ•° >= 1 çš„ç”¨æˆ·
          filtered_contributors=$(echo "$contributors_json" | jq '[.[] | select(.type == "User" and .contributions >= 1) | {login, contributions, avatar_url}]')
          
          echo "contributors<<EOF" >> $GITHUB_OUTPUT
          echo "$filtered_contributors" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate members.ts file
        run: |
          cat > members.ts << 'EOF'
          type Member = {
            avatar: string
            name: string
            title: string
            links: {
              icon: string
              link: string
            }[]
          }[]

          // å†™äº†ä¸ªèµ° CF çš„ä»£ç†ï¼Œä¸ºäº†è®©å¤´åƒåŠ è½½å¿«ç‚¹å„¿
          // æ ¼å¼æš‚æ—¶ä¸ºï¼šhttps://avatars.hdu-cs.wiki/ + github ç”¨æˆ·åï¼ˆä¸æ˜¯æ˜µç§°ï¼‰ï¼ˆä¸åŠ pngï¼‰
          // https://avatars.hdu-cs.wiki/camera-2018

          export const members: Member = [
          EOF
          
          # ä»ŽçŽ¯å¢ƒå˜é‡ä¸­è¯»å–è´¡çŒ®è€…æ•°æ®å¹¶ç”Ÿæˆ TypeScript æ•°ç»„
          echo '${{ steps.fetch-contributors.outputs.contributors }}' | jq -r '.[] | 
            "  {" +
            "\n    avatar: '\''https://avatars.hdu-cs.wiki/" + .login + "'\''," +
            "\n    name: '\''" + .login + "'\''," +
            "\n    title: '\''" + (if .contributions >= 50 then "Maintainer" elif .contributions >= 10 then "Active Contributor" else "Contributor" end) + "'\''," +
            "\n    links: [" +
            "\n      { icon: '\''github'\'', link: '\''https://github.com/" + .login + "'\'' }," +
            "\n    ]" +
            "\n  },"' >> members.ts
          
          echo "]" >> members.ts
          
          # ç§»é™¤æœ€åŽä¸€ä¸ªé€—å·
          sed -i '$s/,$//' members.ts

      - name: Check if there are changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          add-paths: members.ts
          commit-message: "chore: update contributors list"
          title: "ðŸ¤– Auto-update contributors list"
          body: |
            ## ðŸ“ è‡ªåŠ¨æ›´æ–°è´¡çŒ®è€…åˆ—è¡¨
            
            æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼Œç”¨äºŽåŒæ­¥æœ€æ–°çš„è´¡çŒ®è€…ä¿¡æ¯ã€‚
            
            ### ðŸ“Š æ›´æ–°å†…å®¹
            - ä»Ž GitHub API èŽ·å–æœ€æ–°è´¡çŒ®è€…æ•°æ®
            - è‡ªåŠ¨åˆ†ç±»è´¡çŒ®è€…ç­‰çº§ï¼š
              - **Maintainer**: >= 50 è´¡çŒ®
              - **Active Contributor**: >= 10 è´¡çŒ®  
              - **Contributor**: >= 1 è´¡çŒ®
            - è¿‡æ»¤æŽ‰æœºå™¨äººè´¦æˆ·
            
            ### ðŸ”§ æ•°æ®æ¥æº
            ```
            GET https://api.github.com/repos/${{ github.repository }}/contributors
            ```
            
            è¯·æ£€æŸ¥æ›´æ–°å†…å®¹æ˜¯å¦æ­£ç¡®ï¼Œç¡®è®¤æ— è¯¯åŽåˆå¹¶æ­¤ PRã€‚
            
            ---
            *æ­¤ PR ç”± update-contributors.yaml å·¥ä½œæµè‡ªåŠ¨åˆ›å»º*
          branch: auto-update-contributors
          delete-branch: true

      - name: Summary
        run: |
          total_contributors=$(echo '${{ steps.fetch-contributors.outputs.contributors }}' | jq '. | length')
          echo "## ðŸ“Š Contributors Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Contributors**: $total_contributors" >> $GITHUB_STEP_SUMMARY
          echo "- **Changed**: ${{ steps.verify-changed-files.outputs.changed }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Updated At**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.verify-changed-files.outputs.changed }}" == "true" ]; then
            echo "- **Action**: Created/Updated Pull Request" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch**: auto-update-contributors" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Action**: No changes detected" >> $GITHUB_STEP_SUMMARY
          fi