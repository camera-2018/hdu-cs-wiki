# 4.åˆ›å»ºå¯¹è±¡

*åœ¨æˆ‘ä»¬ç»§ç»­ä¹‹å‰ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œä½¿ç”¨çš„æ˜¯[å“²å­¦æ„ä¹‰ä¸Š](https://en.wikipedia.org/wiki/Object_(philosophy))çš„â€œå¯¹è±¡â€ä¸€è¯ã€‚å®ƒä¸[é¢å‘å¯¹è±¡ç¼–ç¨‹](https://en.wikipedia.org/wiki/Object-oriented_programming)æ— å…³ï¼Œä¹Ÿä¸Javaï¼ŒC#å’ŒPythonç­‰ç¼–ç¨‹è¯­è¨€ä¸­é¢„å®šä¹‰çš„â€œå¯¹è±¡â€ç±»å‹æ²¡æœ‰ä»»ä½•å…±åŒä¹‹å¤„ã€‚ä¸‹é¢ï¼Œæˆ‘å°†å®šä¹‰ä¸€ä¸ªåä¸º object çš„ç»“æ„ä½“ã€‚*

å†’é™©æ¸¸æˆä¸­çš„å¤§å¤šæ•°è°œé¢˜éƒ½å›´ç»•ç€**ç‰©å“**ã€‚ä¾‹å­ï¼š

- å¿…é¡»æ‰¾åˆ°ä¸€æŠŠé’¥åŒ™ï¼Œç„¶åç”¨æ¥è§£é”æŸæ‰‡é—¨ã€‚
- å¿…é¡»æ€æ­»å®ˆå«æˆ–è€…è¯±éª—å®ˆå«æ‰èƒ½å¼€å¯æˆ¿é—´

æ‰€ä»¥ï¼Œä¸ºäº†è¡¨ç¤ºè¿™ä¸ªç‰©å“ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹[ç»“æ„](http://en.wikipedia.org/wiki/Struct_(C_programming_language))ï¼š

- **\*description: å¯¹ç‰©å“çš„æè¿°**
- **\*tag: ç‰©å“çš„ç±»å‹**
- **\*location: ç‰©å“æ‰€åœ¨çš„ä½ç½®ã€‚è¿™æ˜¯å¯¹åº”ä¸Šä¸€ç« ä¸­å®šä¹‰çš„ç‰©å“ä½ç½®çš„æŒ‡é’ˆã€‚**

```c
struct object {
   const char   *description;
   const char   *tag;
   struct location *location;
}
objs[] = {
   {"a silver coin", "silver", &locs[0]},
   {"a gold coin"  , "gold"  , &locs[1]},
   {"a burly guard", "guard" , &locs[0]}
};
```

æˆ‘ä»¬å‘ç°è¿™ä¸€ç« çš„ç‰©å“çš„ä¿¡æ¯å’Œä¸Šä¸€ç« å¥½åƒä¹Ÿå·®ä¸å¤šå‘€ï¼Œæ‰€ä»¥æˆ‘ä»¬ç›´æ¥æŠŠä»–åˆå¹¶å¥½äº†ï¼

```c
struct object {
   const char    *description;
   const char    *tag;
   struct object *location;
}
objs[] = {
   {"an open field", "field" , NULL},
   {"a little cave", "cave"  , NULL},
   {"a silver coin", "silver", &objs[0]},
   {"a gold coin"  , "gold"  , &objs[1]},
   {"a burly guard", "guard" , &objs[0]}
};
```

è¿™æ ·å­æˆ‘ä»¬çš„ä»£ç å°±ä¼šçœ‹èµ·æ¥æ›´åŠ ç®€æ´ï¼

æˆ‘ä»¬å‘ç° OBJECT çš„ç»“æ„ä½“é‡Œé¢æœ‰ä¸€ä¸ªæŒ‡é’ˆå’Œè‡ªå·±é•¿å¾—ä¸€æ ·ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œè¿™å’Œé“¾è¡¨çš„æ“ä½œç±»ä¼¼ã€‚

::: warning ğŸ¤” æ€è€ƒé¢˜ï¼š
é“¾è¡¨æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆè¦æœ‰è¿™ä¹ˆä¸€ä¸ªæ“ä½œæŒ‡é’ˆï¼Ÿ

é“¾è¡¨å’Œæ•°ç»„æœ‰ä»€ä¹ˆå¼‚åŒç‚¹ï¼Œä»–ä»¬åˆ†åˆ«åœ¨å¢åˆ æ”¹æŸ¥ä¸Šæœ‰ä»€ä¹ˆä¼˜åŠ£ï¼Ÿ
:::

ä¸ºäº†æ›´å®¹æ˜“åœ°ç”¨é‚£äº›æ‰€è°“çš„ç‰©å“æˆ–è€…æ˜¯åœ°ç‚¹ï¼Œæˆ‘ä»¬å°†ä¸ºæ¯ä¸ªå…ƒç´ å®šä¹‰ä¸€ä¸ªåå­—

```c
#define field   (objs + 0)
#define cave    (objs + 1)
#define silver  (objs + 2)
#define gold    (objs + 3)
#define guard   (objs + 4)
```

å¦‚ä½•ç”¨å„ä¸ªå…ƒç´ çš„æŒ‡é’ˆæ¥æ–¹ä¾¿çš„è¿›è¡Œæ“ä½œå‘¢ï¼Ÿ

```c
printf("You are in %s.\n", field->description);
```

ç„¶åç”¨è¿™æ ·çš„æ“ä½œå¯ä»¥åˆ—å‡ºä¸€ä¸ªç‰©å“é‡Œé¢æ‰€æœ‰çš„å°ä¸œè¥¿

```c
struct object *obj;
for (obj = objs; obj < objs + 5; obj++)
{
   if (obj->location == cave)
   {
      printf("%s\n", obj->description);
   }
}
```

::: warning ğŸ¤” æš‚åœç†è§£ä¸€ä¸‹å§
:::

é‚£ä¹ˆï¼Œæˆ‘ä»¬æœ‰åˆå¹¶è¿™ä¸ªç‰©å“ï¼ˆæˆ–åœ°ç‚¹ï¼‰åˆ—è¡¨æœ‰ä»€ä¹ˆå¥½å¤„å‘¢ï¼Ÿç­”æ¡ˆæ˜¯è¿™ä¼šè®©æˆ‘ä»¬çš„ä»£ç å˜å¾—æ›´åŠ ç®€å•ï¼Œå› ä¸ºè®¸å¤šå‡½æ•°ï¼ˆå¦‚ä¸Šé¢çš„å‡½æ•°é€šè¿‡è¿™æ ·çš„åˆ—è¡¨ï¼‰åªéœ€è¦æ‰«æå•ä¸ªåˆ—è¡¨å°±å¯ä»¥å®ç°ï¼Œè€Œä¸æ˜¯ä¸‰ä¸ªåˆ—è¡¨ã€‚æœ‰äººå¯èƒ½ä¼šè¯´æ²¡å¿…è¦ï¼Œå› ä¸ºæ¯ä¸ªå‘½ä»¤ä»…é€‚ç”¨äºä¸€ç§ç±»å‹çš„å¯¹è±¡ï¼š

- å‘½ä»¤ *go* é€‚ç”¨äºä½ç½®å¯¹è±¡ã€‚
- å‘½ä»¤ *get* åº”ç”¨äºè·å¾—ç‰©å“ã€‚
- å‘½ä»¤ kill é€‚åº”ç”¨äºæ€æ­»äººç‰©ã€‚

ä½†è¿™ç§æ–¹æ³•ä¸å¤ªå¯¹åŠ²ï¼ŒåŸå› æœ‰ä¸‰ï¼š

1. æŸäº›å‘½ä»¤é€‚ç”¨äºå¤šç§ç±»å‹çš„å¯¹è±¡ï¼Œå°¤å…¶æ˜¯*æ£€æŸ¥*ã€‚
2. æœ‰æ—¶å€™ä¼šå‡ºç°å¾ˆæ²¡æ„æ€çš„äº¤äº’æ–¹å¼ï¼Œæ¯”å¦‚è¯´ä½ è¦åƒæ‰å®ˆå«ï¼Œä»–è¯´ä¸è¡Œã€‚
3. æŸäº›å¯¹è±¡åœ¨æ¸¸æˆä¸­å¯èƒ½å…·æœ‰å¤šä¸ªè§’è‰²ã€‚æ¯”å¦‚è¯´é˜Ÿå‹ç³»ç»Ÿï¼ŒNPC å¯ä»¥æ˜¯ä½ çš„ç‰©å“ä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡

å°†æ‰€æœ‰å¯¹è±¡æ”¾åœ¨ä¸€ä¸ªå¤§åˆ—è¡¨ä¸­ï¼Œå¾ˆå®¹æ˜“æ·»åŠ ä¸€ä¸ªåä¸ºâ€œtypeâ€çš„å±æ€§æ¥*æ„é€ å¯¹è±¡*ï¼Œä»¥å¸®åŠ©æˆ‘ä»¬åŒºåˆ†ä¸åŒç±»å‹çš„å¯¹è±¡ã€‚

::: warning ğŸ¤” æ€ä¹ˆåšæ€ä¹ˆéå†å‘¢ï¼Ÿå…ˆæ€è€ƒå§
:::

ä½†æ˜¯ï¼Œå¯¹è±¡é€šå¸¸å…·æœ‰åŒæ ·æœ‰æ•ˆçš„å…¶ä»–ç‰¹å¾ï¼š

- **Locationsï¼šé€šè¿‡é“è·¯è¿æ¥ï¼ˆå°†åœ¨åé¢ä»‹ç»ï¼‰ã€‚å¦‚æœä¸€ä¸ªç‰©ä½“æ— æ³•é€šè¿‡ä¸€æ¡é€šé“åˆ°è¾¾ï¼Œé‚£ä¹ˆå®ƒå°±ä¸æ˜¯ä¸€ä¸ªä½ç½®ã€‚å°±æ˜¯è¿™ä¹ˆç®€å•ã€‚**
- **Itemsï¼šç©å®¶å”¯ä¸€å¯ä»¥æ¡èµ·çš„ç‰©å“;å¯ä»¥ç»™ä»–ä»¬æ•´ä¸€ä¸ªé‡é‡çš„å±æ€§**
- **Actorsï¼šç©å®¶å”¯ä¸€å¯ä»¥ä¸ä¹‹äº¤è°ˆï¼Œäº¤æ˜“ï¼Œæˆ˜æ–—çš„å¯¹è±¡;å½“ç„¶ï¼Œå‰ææ˜¯ä»–ä»¬è¿˜æ´»ç€ï¼å¯ä»¥åŠ ä¸€ä¸ª HP å±æ€§**

æˆ‘ä»¬è¿˜è¦å‘æ•°ç»„ä¸­æ·»åŠ ä¸€ä¸ªå¯¹è±¡ï¼šç©å®¶è‡ªå·±ã€‚

åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæœ‰ä¸€ä¸ªå•ç‹¬çš„å˜é‡ *locationOfPlayer*ã€‚æˆ‘ä»¬å°†åˆ é™¤å®ƒï¼Œç„¶åæ¢ä¸Šç”¨æˆ·çš„ä½ç½®å±æ€§å–ä»£ä»–ï¼

ä¾‹å¦‚ï¼Œæ­¤è¯­å¥ä¼šå°†ç©å®¶ç§»å…¥æ´ç©´ï¼š

```c
player->location = cave;
```

æ­¤è¡¨è¾¾å¼è¿”å›ç©å®¶å½“å‰ä½ç½®çš„æè¿°ï¼š

```c
player->location->description
```

æ˜¯æ—¶å€™æŠŠå®ƒä»¬æ”¾åœ¨ä¸€èµ·äº†ã€‚æˆ‘ä»¬ä»å¯¹è±¡æ•°ç»„çš„å…¨æ–°æ¨¡å—å¼€å§‹

## Object.h

```c
typedef struct object {
   const char    *description;
   const char    *tag;
   struct object *location;
} OBJECT;

extern OBJECT objs[];

#define field      (objs + 0)
#define cave       (objs + 1)
#define silver     (objs + 2)
#define gold       (objs + 3)
#define guard      (objs + 4)
#define player     (objs + 5)

#define endOfObjs  (objs + 6)
```

## Object.c

```c
#include <stdio.h>
#include "object.h"

OBJECT objs[] = {
   {"an open field", "field"   , NULL  },
   {"a little cave", "cave"    , NULL  },
   {"a silver coin", "silver"  , field },
   {"a gold coin"  , "gold"    , cave  },
   {"a burly guard", "guard"   , field },
   {"yourself"     , "yourself", field }
};
```

<strong>æ³¨æ„ï¼š</strong>è¦ç¼–è¯‘æ­¤æ¨¡å—ï¼Œç¼–è¯‘å™¨*å¿…é¡»*æ”¯æŒ Constant foldingã€‚è¿™æ’é™¤äº†ä¸€äº›æ›´åŸå§‹çš„ç¼–è¯‘å™¨ï¼Œå¦‚ [Z88DK](http://en.wikipedia.org/wiki/Z88DK)ã€‚

ä»¥ä¸‹æ¨¡å—å°†å¸®åŠ©æˆ‘ä»¬æ‰¾åˆ°ä¸æŒ‡å®šåè¯åŒ¹é…çš„å¯¹è±¡ã€‚

## noun.h

```c
extern OBJECT *getVisible(const char *intention, const char *noun);
```

::: warning <font size=5>**ğŸ¤” æŒ‡é’ˆï¼Ÿå‡½æ•°ï¼Ÿå¸Œæœ›ä½ å·²ç»æŒæ¡è¿™æ˜¯ä»€ä¹ˆäº†**</font>
:::

## noun.c

```c
#include <stdbool.h>
#include <stdio.h>
#include <string.h>
#include "object.h"

static bool objectHasTag(OBJECT *obj, const char *noun)
{
   return noun != NULL && *noun != '\0' && strcmp(noun, obj->tag) == 0;
}

static OBJECT *getObject(const char *noun)
{
   OBJECT *obj, *res = NULL;
   for (obj = objs; obj < endOfObjs; obj++)
   {
      if (objectHasTag(obj, noun))
      {
         res = obj;
      }
   }
   return res;
}

OBJECT *getVisible(const char *intention, const char *noun)
{
   OBJECT *obj = getObject(noun);
   if (obj == NULL)
   {
      printf("I don't understand %s.\n", intention);
   }
   else if (!(obj == player || 
               //ç©å®¶æœ¬äººã€‚æ˜¯çš„ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ä¸ªå¯è§çš„ç‰©ä½“ã€‚
              obj == player->location ||
               //ç©å®¶çš„å½“å‰ä½ç½®ã€‚
              obj->location == player ||
               //ç©å®¶æŒæœ‰çš„ç‰©å“
              obj->location == player->location ||
               //ç©å®¶å½“å‰ä½ç½®çš„ç‰©ä½“
              obj->location == NULL ||
               //ç©å®¶å¯ä»¥å»çš„ä»»æ„ä½ç½®ï¼Œå…·ä½“å®Œå–„åœ¨åé¢
              obj->location->location == player ||
               //ç©å®¶æŒæœ‰çš„å¦ä¸€ä¸ªç‰©ä½“å†…çš„ç‰©ä½“
              obj->location->location == player->location))
               //å½“å‰ä½ç½®å­˜åœ¨çš„å¦ä¸€ä¸ªå¯¹è±¡å†…éƒ¨çš„å¯¹è±¡
   {
      printf("You don't see any %s here.\n", noun);
      obj = NULL;
   }
   return obj;
   //æ„Ÿå—åˆ°æ³¨é‡Šæœ‰å¤šä¼Ÿå¤§äº†å§
}
```

è¿™æ˜¯å¦ä¸€ä¸ªè¾…åŠ©ç¨‹åºçš„å‡½æ•°ã€‚å®ƒæ‰“å°å­˜åœ¨äºç‰¹å®šä½ç½®çš„å¯¹è±¡ï¼ˆç‰©å“ï¼ŒNPCï¼‰çš„åˆ—è¡¨ã€‚å®ƒå°†ç”¨äºå‡½æ•° *executeLook*ï¼Œåœ¨ä¸‹ä¸€ç« ä¸­ï¼Œæˆ‘ä»¬å°†ä»‹ç»å¦ä¸€ä¸ªéœ€è¦å®ƒçš„å‘½ä»¤ã€‚

## misc.h

```c
extern int listObjectsAtLocation(OBJECT *location);
```

## misc.c

```c
#include <stdio.h>
#include "object.h"

int listObjectsAtLocation(OBJECT *location)
{
   int count = 0;
   OBJECT *obj;
   for (obj = objs; obj < endOfObjs; obj++)
   {
      if (obj != player && obj->location == location)
      //æ’é™¤ç©å®¶åœ¨ç©å®¶çš„ä½ç½®è¿™ç§è ¢ä¸œè¥¿
      {
         if (count++ == 0)
         //æˆ‘ä»¬éœ€è¦ä¿è¯æ‰¾åˆ°ä¸€ä¸ªä¸œè¥¿ä¹‹å‰ä»–ä¸ä¼šæ‰“å° you see
         {
            printf("You see:\n");
         }
         printf("%s\n", obj->description);
      }
   }
   return count;
   //è¿”å›çš„æ˜¯æ•°ç›®çš„æ•°é‡ï¼Œä¸‹ä¸€ç« å¯¹æ­¤åšé¢å¤–æ“ä½œ
}
```

åœ¨ *location.c* ä¸­ï¼Œå‘½ä»¤ç¯*é¡¾å››å‘¨çš„å®ç°*ï¼Œå¹¶æ ¹æ®æ–°çš„æ•°æ®ç»“æ„è¿›è¡Œè°ƒæ•´ã€‚æ—§çš„ä½ç½®æ•°ç»„è¢«åˆ é™¤ï¼Œå˜é‡ *locationOfPlayer* ä¹Ÿæ˜¯å¦‚æ­¤ã€‚

## location.h

```c
extern void executeLook(const char *noun);
extern void executeGo(const char *noun);
```

## location.c

```c
#include <stdio.h>
#include <string.h>
#include "object.h"
#include "misc.h"
#include "noun.h"

void executeLook(const char *noun)
{
   if (noun != NULL && strcmp(noun, "around") == 0)
   {
      printf("You are in %s.\n", player->location->description);
      listObjectsAtLocation(player->location);
      //æ˜¾ç¤ºå½“å‰ä½ç½®çš„ç©å®¶å’Œç‰©å“
   }
   else
   {
      printf("I don't understand what you want to see.\n");
   }
}

void executeGo(const char *noun)
{
//æ¶ˆé™¤äº†å‡½æ•°*executeGo*ä¸­çš„å¾ªç¯ï¼Œä»£ç æ›´ä¼˜é›…äº†~
   OBJECT *obj = getVisible("where you want to go", noun);
   if (obj == NULL)
   {
      // already handled by getVisible
   }
   else if (obj->location == NULL && obj != player->location)
   {
      printf("OK.\n");
      player->location = obj;
      executeLook("around");
   }
   else
   {
      printf("You can't get much closer than this.\n");
   }
}
```

ä½ å¯ä»¥è‡ªç”±æ·»åŠ å¯¹è±¡å“¦ï¼Œè‡ªå·±è®¾è®¡ä¸€ä¸ªæ¸¸æˆé“å…·ä¸€å®šå¾ˆæœ‰æ„æ€

ç°åœ¨é‡‘é“¶å®ç‰©æ•£è½ä¸€åœ°å¯æ˜¯æˆ‘ä»¬æ¡ä¸èµ·æ¥ï¼Œä¸‹ä¸€ç« æˆ‘ä»¬ä¼šè¯•ç€è§£å†³é—®é¢˜

æµ‹è¯•æ ·ä¾‹ï¼š

Welcome to Little Cave Adventure.
You are in an open field.
You see:
a silver coin
a burly guard

--> go cave
OK.
You are in a little cave.
You see:
a gold coin

--> go field
OK.
You are in an open field.
You see:
a silver coin
a burly guard

--> go field
You can't get much closer than this.

--> look around
You are in an open field.
You see:
a silver coin
a burly guard

--> quit

Bye!
