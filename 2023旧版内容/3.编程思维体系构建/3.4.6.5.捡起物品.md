# 5.æ¡èµ·ç‰©å“

åœ¨ä¸Šä¸€ç« ä¸­ï¼Œæˆ‘ä»¬åˆ¶ä½œäº†ä¸€ä¸ªå¤§å¤§å¤§æ•°ç»„æ¥å­˜å‚¨æ‰€æœ‰å¯¹è±¡ï¼ŒåŒ…æ‹¬ç©å®¶æœ¬äººã€‚

é€šè¿‡å°†ç©å®¶è§†ä¸ºå¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œä½ å·²ç»æˆä¸ºäº†æ¸¸æˆçš„é‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè€Œä¸æ˜¯ä»¥å±€å¤–äººçš„è§†è§’çœ‹ä¸–ç•Œã€‚

è¿™ç§æ–¹æ³•çš„ä¼˜åŠ¿åœ¨å…·æœ‰ç©å®¶è§’è‰²çš„æ¸¸æˆä¸­å˜å¾—æœ€ä¸ºæ˜æ˜¾ï¼Œä½ å¯ä»¥æ¢äºº hhhhhã€‚

ç©å®¶å±æ€§ä¸å†éœ€è¦å­˜å‚¨åœ¨å•ç‹¬çš„å˜é‡ä¸­;æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸ä»»ä½•å…¶ä»–å¯¹è±¡ç›¸åŒçš„æ•°æ®ç»“æ„ã€‚æ‰€ä»¥ç©å®¶ï¼Œä½œä¸ºä¸€ä¸ªå¯¹è±¡å¿…é¡»å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

- æ‰€å¤„ä½ç½®ï¼ˆæˆ‘åœ¨å“ªï¼‰
- ç©å®¶å¯èƒ½æŒæœ‰çš„ä»»ä½•ç‰©å“çš„ä½ç½®ã€‚

è¿™ä½¿å¾—æŸäº›å¸¸è§æ“ä½œéå¸¸å®¹æ˜“å®ç°ï¼š

|**Action**|**Typical Command**|**Example**|
| ------------------------------ | --------- | ------------------------------------ |
| ç©å®¶ä»ä¸€ä¸ªä½ç½®ç§»åŠ¨åˆ°å¦ä¸€ä¸ªä½ç½® | go        | player->location = cave;             |
| åˆ—å‡ºæŸä¸ªä½ç½®å­˜åœ¨çš„é¡¹å’Œå‚ä¸è€…   | look      | listObjectsAtLocation(cave);         |
| ç©å®¶è·å–ç‰©å“                   | get       | silver->location = player;           |
| ç©å®¶æ‰è½ç‰©å“                   | drop      | silver->location = player->location; |
| åˆ—å‡ºç©å®¶çš„ç‰©å“æ                | inventory | listObjectsAtLocation(player);       |
| ç©å®¶å°†ç‰©å“èµ é€ç»™æ¼”å‘˜           | give      | listObjectsAtLocation(player);       |
| ç©å®¶ä»æ¼”å‘˜é‚£é‡Œæ”¶åˆ°ç‰©å“         | ask       | silver->location = player;           |
| åˆ—å‡ºå…¶ä»–æ¼”å‘˜çš„åº“å­˜             | examine   | listObjectsAtLocation(guard);        |

ä½ å¯ä»¥å°è¯•å»ä½¿ç”¨è¿™äº›å‘½ä»¤ï¼ˆä¸Šé¢çš„å‰ä¸¤ä¸ªç¤ºä¾‹å·²ç»åœ¨ä¸Šä¸€ç« ä¸­å®ç°äº†ï¼‰ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å°†ä¸ºç©å®¶å’Œéç©å®¶è§’è‰²ä»‹ç»ä¸€äº›å…¸å‹çš„**ç‰©å“æ **æ“ä½œï¼ˆå‘½ä»¤*è·å–*ã€*æ‰è½*ã€*ç»™äºˆ*ã€*è¯¢é—®*å’Œ*ç‰©å“æ *ï¼‰ã€‚

::: warning ğŸ¤” æ€è€ƒé¢˜ï¼š
ä½ èƒ½ä¸èƒ½å°è¯•è‡ªå·±å®ç°ä¸€ä¸‹ä¸Šé¢çš„å‘½ä»¤ï¼Ÿ

å¦‚æœä½ å¯ä»¥åœ¨ä¸å‚è€ƒä¸‹é¢å†…å®¹çš„æƒ…å†µä¸‹å°±å†™å‡ºåŸºæœ¬å†…å®¹ä¼šæœ‰å¾ˆå¤§æ”¶è·çš„
:::

## parsexec.c

```c
#include <stdbool.h>
#include <stdio.h>
#include <string.h>
#include "location.h"
#include "inventory.h"      //è¿™æ˜¯ä¸€ä¸ªæ–°æ¨¡å—

bool parseAndExecute(char *input)
{
   char *verb = strtok(input, " \n");
   char *noun = strtok(NULL, " \n");
   //ç¬¬äºŒæ¬¡ä½¿ç”¨ strtok è¦ç”¨ NULL ä¼ å‚
   if (verb != NULL)
   {
      if (strcmp(verb, "quit") == 0)      
      {
         return false;
      }
      else if (strcmp(verb, "look") == 0)    //ä½¿æ¸¸æˆè¯†åˆ«ä¸Šè¿°å‘½ä»¤
      {
         executeLook(noun);
      }
      else if (strcmp(verb, "go") == 0)
      {
         executeGo(noun);
      }
      else if (strcmp(verb, "get") == 0)    
      {
         executeGet(noun);
      }
      else if (strcmp(verb, "drop") == 0)
      {
         executeDrop(noun);
      }
      else if (strcmp(verb, "give") == 0)
      {
         executeGive(noun);
      }
      else if (strcmp(verb, "ask") == 0)
      {
         executeAsk(noun);
      }
      else if (strcmp(verb, "inventory") == 0)
      {
         executeInventory();
      }
      else
      {
         printf("I don't know how to '%s'.\n", verb);
      }
   }
   return true;
}
```

æ–°å‘½ä»¤ç”±ä»¥ä¸‹æ¨¡å—å®ç°ã€‚

## inventory.h

```c
extern void executeGet(const char *noun);
extern void executeDrop(const char *noun);
extern void executeAsk(const char *noun);
extern void executeGive(const char *noun);
extern void executeInventory(void);
```

## inventory.c

```c
#include <stdio.h>
#include "object.h"
#include "misc.h"
#include "noun.h"
#include "move.h"

void executeGet(const char *noun)
{
   OBJECT *obj = getVisible("what you want to get", noun);
   if (obj == NULL)
   {
      // already handled by getVisible
   }
   else if (obj == player)
   {
      printf("You should not be doing that to yourself.\n");
   }
   else if (obj->location == player)
   {
      printf("You already have %s.\n", obj->description);
   }
   else if (obj->location == guard)
   {
      printf("You should ask %s nicely.\n", obj->location->description);
   }
   else
   {
      moveObject(obj, player);   
      //ç”¨äºå°†å¯¹è±¡ä¼ è¾“åˆ°å…¶æ–°ä½ç½®
   }
}

void executeDrop(const char *noun)
{
   moveObject(getPossession(player, "drop", noun), player->location);
}

void executeAsk(const char *noun)
{
   moveObject(getPossession(actorHere(), "ask", noun), player);
}

void executeGive(const char *noun)
{
   moveObject(getPossession(player, "give", noun), actorHere());
}

void executeInventory(void)
{
   if (listObjectsAtLocation(player) == 0)  //å‡½æ•°è¿”å›å€¼å‘Šè¯‰æˆ‘ä»¬æœ‰å¤šå°‘ä¸ªå¯¹è±¡
   {
      printf("You are empty-handed.\n"); //å‘Šè¯‰ç”¨æˆ·å•¥ä¹Ÿæ²¡æœ‰
   }
}
```

æ³¨æ„ï¼šç”±äºåŠ¨è¯åè¯æ¯”è¾ƒå¥½å¼„ï¼Œå‘½ä»¤ *ask* å’Œ *give* åªæœ‰ä¸€ä¸ªå‚æ•°ï¼šitemã€‚

::: warning ğŸ¤” æ€è€ƒé¢˜ï¼š
ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è¿™æ ·è®¾è®¡ï¼Ÿ

ä½ èƒ½å¦ä¸ºè¿™äº›å‘½ä»¤å¤šåŠ å‡ ä¸ªå‚æ•°ï¼Ÿ
:::

ä»æœ¬è´¨ä¸Šè®²ï¼Œ*get*, *drop*, *give* and *ask è¿™äº›å‘½ä»¤*é™¤äº†å°†é¡¹ç›®ä»ä¸€ä¸ªåœ°æ–¹ç§»åŠ¨åˆ°å¦ä¸€ä¸ªåœ°æ–¹ä¹‹å¤–ï¼Œä»€ä¹ˆéƒ½ä¸åšã€‚å•ä¸ªå‡½æ•° *move å¯¹è±¡*å¯ä»¥å¯¹æ‰€æœ‰å››ä¸ªå‘½ä»¤æ‰§è¡Œè¯¥æ“ä½œã€‚

## move.h

```c
extern void moveObject(OBJECT *obj, OBJECT *to);
```

## move.c

```c
#include <stdio.h>
#include "object.h"

static void describeMove(OBJECT *obj, OBJECT *to)  //ç¡®è®¤ç§»åŠ¨å‘½ä»¤
{
   if (to == player->location)    
   {
      printf("You drop %s.\n", obj->description);
   }
   else if (to != player)
   {
      printf(to == guard ? "You give %s to %s.\n" : "You put %s in %s.\n",
             obj->description, to->description);
   }
   else if (obj->location == player->location)
   {
      printf("You pick up %s.\n", obj->description);
   }
   else
   {
      printf("You get %s from %s.\n",
             obj->description, obj->location->description);
   }
}

void moveObject(OBJECT *obj, OBJECT *to)  
{
   if (obj == NULL)      //ä¸ç§»åŠ¨çš„å„ç§æ¡ä»¶
   {
      // already handled by getVisible or getPossession
   }
   else if (to == NULL)
   {
      printf("There is nobody here to give that to.\n");
   }
   else if (obj->location == NULL)  //æœ‰äº›ç‰©ä½“æ— æ³•æ‹¾å–ï¼Œå…·ä½“è¯†åˆ«æ¡ä»¶å°†åœ¨åé¢å¾—åˆ°æ”¹è¿›
   {
      printf("That is way too heavy.\n");
   }
   else
   {
      describeMove(obj, to);
      obj->location = to;  //ç§»åŠ¨å¯¹è±¡
   }
}
```

::: warning ğŸ¤” æ€è€ƒé¢˜ï¼šè¯†åˆ«ä¸€äº›æˆ‘ä»¬æ‹¿ä¸äº†çš„ç‰©å“éœ€è¦è€ƒè™‘ä»€ä¹ˆå› ç´ ï¼Ÿ
:::

å‘½ä»¤â€œgetâ€ä½¿ç”¨å‡½æ•°*getVisible*å°†åè¯è½¬æ¢ä¸º objectï¼Œå°±åƒå‘½ä»¤â€œgoâ€ä¸€æ ·;è¯·å‚é˜…ä¸Šä¸€ç« ã€‚ä½†æ˜¯å¯¹äºå¯¹ç©å®¶ï¼ˆæˆ–å…¶ä»–ä¸€äº›å‚ä¸è€…ï¼‰å·²ç»æŒæœ‰çš„å¯¹è±¡è¿›è¡Œ*drop*, *ask*, *give ç­‰*å‘½ä»¤æ—¶ï¼Œæˆ‘ä»¬éœ€è¦ç¨å¾®ä¸åŒçš„ä¸œè¥¿ã€‚æˆ‘ä»¬å°†åœ¨ *noun.c* ä¸­æ·»åŠ ä¸€ä¸ªå‡½æ•° *getPossession*ã€‚

## noun.h

```c
extern OBJECT *getVisible(const char *intention, const char *noun);
extern OBJECT *getPossession(OBJECT *from, const char *verb, const char *noun);
```

## noun.c

```c
#include <stdbool.h>
#include <stdio.h>
#include <string.h>
#include "object.h"

static bool objectHasTag(OBJECT *obj, const char *noun)
{
   return noun != NULL && *noun != '\0' && strcmp(noun, obj->tag) == 0;
}

static OBJECT *getObject(const char *noun)
{
   OBJECT *obj, *res = NULL;
   for (obj = objs; obj < endOfObjs; obj++)
   {
      if (objectHasTag(obj, noun))
      {
         res = obj;
      }
   }
   return res;
}

OBJECT *getVisible(const char *intention, const char *noun)
{
   OBJECT *obj = getObject(noun);
   if (obj == NULL)
   {
      printf("I don't understand %s.\n", intention);
   }
   else if (!(obj == player ||
              obj == player->location ||
              obj->location == player ||
              obj->location == player->location ||
              obj->location == NULL ||
              obj->location->location == player ||
              obj->location->location == player->location))
   {
      printf("You don't see any %s here.\n", noun);
      obj = NULL;
   }
   return obj;
}

OBJECT *getPossession(OBJECT *from, const char *verb, const char *noun)
{
   OBJECT *obj = NULL;
   if (from == NULL)
   {
      printf("I don't understand who you want to %s.\n", verb);
   }
   else if ((obj = getObject(noun)) == NULL)
   {
      printf("I don't understand what you want to %s.\n", verb);
   }
   else if (obj == from)
   {
      printf("You should not be doing that to %s.\n", obj->description);
      obj = NULL;
   }
   else if (obj->location != from)
   {
      if (from == player)
      {
         printf("You are not holding any %s.\n", noun);
      }
      else
      {
         printf("There appears to be no %s you can get from %s.\n",
                noun, from->description);
      }
      obj = NULL;
   }
   return obj;
}
```

æ³¨æ„ï¼šæ–°å‡½æ•°ï¼ˆ45-75 è¡Œï¼‰ *getPossession* æ˜¯ *getObject* çš„è£…é¥°å™¨ï¼ˆwrapperï¼‰ï¼ˆå‚è§ç¬¬ 52 è¡Œï¼‰ï¼Œå®ƒè¦ä¹ˆè¿”å›åŒ¹é…çš„å¯¹è±¡ï¼Œè¦ä¹ˆè¿”å› NULLï¼ˆå¦‚æœæ²¡æœ‰åˆé€‚çš„å¯¹è±¡ä¸åè¯åŒ¹é…ï¼‰ã€‚

å‡½æ•° *actor è¿™é‡Œ*ç”¨äºå‘½ä»¤ *give* å’Œ *ask*ï¼Œä½†å®ƒä¹Ÿå¯èƒ½ç”±å…¶ä»–å‘½ä»¤è°ƒç”¨ã€‚æ‰€ä»¥æˆ‘ä»¬åœ¨*misc.c*ä¸­å®šä¹‰äº†å®ƒã€‚

## misc.h

```c
extern OBJECT *actorHere(void);
extern int listObjectsAtLocation(OBJECT *location);
```

## misc.c

```c
#include <stdio.h>
#include "object.h"

OBJECT *actorHere(void)
{
   OBJECT *obj;
   for (obj = objs; obj < endOfObjs; obj++)
   {
      if (obj->location == player->location && obj == guard) 
      {
         return obj;
      }
   }
   return NULL;
}

int listObjectsAtLocation(OBJECT *location)
{
   int count = 0;
   OBJECT *obj;
   for (obj = objs; obj < endOfObjs; obj++)
   {
      if (obj != player && obj->location == location)
      {
         if (count++ == 0)
         {
            printf("You see:\n");
         }
         printf("%s\n", obj->description);
      }
   }
   return count;
}
```

::: warning ğŸ¤” æ€è€ƒé¢˜ï¼šä¸Šé¢ç¬¬å››è¡Œä¸­çš„å‡½æ•° actorHere è¿”å›çš„æŒ‡é’ˆæŒ‡å‘ä»€ä¹ˆï¼Ÿ
:::

åœ¨ç¬¬ 9 è¡Œä¸­ï¼Œæœ‰ä¸€ä¸ªè¯¦å°½çš„ï¼Œç¡¬ç¼–ç çš„éç©å®¶è§’è‰²åˆ—è¡¨ï¼ˆåˆ°ç›®å‰ä¸ºæ­¢ï¼Œåªæœ‰ä¸€ä¸ªï¼š*å®ˆå«*ï¼‰ã€‚

åœ¨ç¬¬ 10 ç« ä¸­ï¼Œæˆ‘ä»¬å°†å¼€å§‹ä½¿ç”¨å±æ€§ä½œä¸ºåŒºåˆ†è§’è‰²ä¸é¡¹ç›®å’Œå…¶ä»–éå‚ä¸è€…å¯¹è±¡çš„æ›´ä¼˜é›…æ–¹å¼ã€‚

æµ‹è¯•æ ·ä¾‹

Welcome to Little Cave Adventure.
You are in an open field.
You see:
a silver coin
a burly guard

--> get silver
You pick up a silver coin.

--> inventory
You see:
a silver coin

--> look around
You are in an open field.
You see:
a burly guard

--> give silver
You give a silver coin to a burly guard.

--> inventory
You are empty-handed.

--> ask silver
You get a silver coin from a burly guard.

--> inventory
You see:
a silver coin

--> go cave
OK.
You are in a little cave.
You see:
a gold coin

--> give silver
There is nobody here to give that to.

--> drop silver
You drop a silver coin.

--> look around
You are in a little cave.
You see:
a silver coin
a gold coin

--> inventory
You are empty-handed.

--> quit

Bye!
