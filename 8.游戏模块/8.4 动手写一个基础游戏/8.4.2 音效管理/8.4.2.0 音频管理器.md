# 实现一个音频管理器

## 学习目标

完成本教程后，你会学会

1. 如何统一播放游戏内的音频

## 操作流程

1. 在Project视图中，在Resources目录下建立文件夹，名为**Sounds**
2. 实现代码

```csharp
using System;
using System.Collections.Generic;
using System.Linq;
using DG.Tweening;
using UnityEngine;
using Random = UnityEngine.Random;

//声音管理器
public class AudioManager : MonoBehaviour
{
    [Header("BGM音频源")]
    public AudioSource bgmSource;
    private List<AudioClip> PlayList = new (); //播放列表
    private int bgmIndex = -1;
    public static AudioManager Instance; // 单例模式
    public float EffectVolume = 1f;
    private float totalVolume = 0.7f;
    public float bgmVolume = 1f;
    private List<AudioSource> effectSources = new();
    private Dictionary<object, float> lastPlayedTimes = new ();

    private void Awake()
    {
        Instance = this;
    }

    public void Init()
    {
        bgmSource = gameObject.AddComponent<AudioSource>();
    }

    public void ChangeBgmVolume(float volume)
    {
        bgmVolume = volume;
        bgmSource.volume = volume * totalVolume;
    }

    public void ChangeEffectVolume(float volume)
    {
        EffectVolume = volume;
    }
    
    private void Update()
    {
        if (bgmSource == null) return;
        if (!bgmSource.isPlaying)
        {
            PlayGameBgmList(true);
        }
    }
    
    public void PlayBGMList(List<AudioClip> bgmList)
    {
        if (bgmList == null || bgmList.Count == 0)
        {
            return;
        }
        RandomPlayList(bgmList);
        PlayGameBgmList();
    }
    
    public void PlayBGM(string name)
    {
        AudioClip clip = Resources.Load<AudioClip>("Sounds/Music/" + name);
        PlayBGMList(new List<AudioClip>(){clip});
    }

    private void PlayGameBgmList(bool next = true)
    {
        
        StopAllCoroutines();
        if (PlayList.Count == 0)
        {
            return;
        }

        if (bgmSource.isPlaying && bgmIndex != -1)
        {
            return;
        }
        if (next)
        {
            if (tempClip != null && PlayList.Contains(tempClip))
            {
                PlayList.Remove(tempClip);
                tempClip = null;
            }
            else
            {
                bgmIndex++;
            }
            
        }
        if (bgmIndex >= PlayList.Count)
        {
            bgmIndex = 0;
        }
        
        AudioClip clip = PlayList[bgmIndex];
        bgmSource.clip = clip;
        bgmSource.Play();
    }

    //播放音效
    public void PlayEffect(string name)
    {
        AudioClip clip = Resources.Load<AudioClip>("Sounds/" + name);
        PlayEffect(clip);
    }
    public void PlayEffect(AudioClip clip)
    {
        if (clip == null) return;
        //检查是否在短时间内重复播放同一音效
        if (lastPlayedTimes.TryGetValue(clip, out var lastTime) && Time.time - lastTime < 0.1f)
        {
            return; // 如果在0.1秒内重复播放，则不播放
        }
        lastPlayedTimes[clip] = Time.time; // 更新最后播放时间
        bgmSource.PlayOneShot(clip);
    }
    public AudioClip tempClip=null;
    private void RandomPlayList(List<AudioClip> BGMList)
    {
        PlayList = new (BGMList.ToArray());
        //随机打乱播放列表
        for (int i = 0; i < PlayList.Count; i++)
        {

            var temp = PlayList[i];
            int randomIndex = Random.Range(i, PlayList.Count);
            PlayList[i] = PlayList[randomIndex];
            PlayList[randomIndex] = temp;
        }
        PlayList=new List<AudioClip> { PlayList[0] };
        bgmSource.Stop();
    }
}
```

3. 将组件拖入**GameManager**物体上

## 概念解释

### AudioSource

AudioSource是一个播放音频资源的组件，AudioClip代表具体的可读取资源。

你可以理解成AudioSource是播放器，AudioClip是音乐文件。

### 单例模式

由于整个游戏只需要一个音频管理器，需要保证全局唯一性，我们采用单例模式。在类初始化时向外提供其实例的引用，这样保证了在项目中可以随时访问到这个单例。详情请见 **设计模式-单例模式**
