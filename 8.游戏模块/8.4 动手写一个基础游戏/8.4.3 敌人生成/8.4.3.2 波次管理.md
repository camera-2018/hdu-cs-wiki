# 实现关卡波次管理与复活

## 实现流程

### 新建 GameApp 类

1. 新建 GameApp 类并挂载到 GameManager 中
2. 实现

```csharp
using System;
using Character;
using DG.Tweening;
using TMPro;
using UnityEngine;

public class GameApp : MonoBehaviour
{
    public enum GameState
    {
        None,
        Fight,
        Break,
        Dead,
    }
    public static GameApp Instance { get; private set; }
    public GameState State { get; set; } = GameState.None;
    public int Level = 1;

    private void Awake()
    {
        Instance = this;
    }

    private void Start()
    {
        Init();
        SpawnPlayer();
    }

    private void Init()
    {
        AudioManager.Instance.Init();
        AudioManager.Instance.PlayBGM("PixelCanon"); // 播放背景音乐
        Cursor.visible = false;
    }

    private void Update()
    {
        if (State == GameState.Dead && Input.GetKeyDown(KeyCode.R))
        {
            SpawnPlayer();
        }
    }

    private void SpawnPlayer()
    {
        // 查找所有敌人并销毁
        var enemies = FindObjectsOfType<Enemy>();
        foreach (var enemy in enemies)
        {
            enemy.SetDead(); // 调用敌人的死亡方法
        }

        Level = 0;
        PlayerController.Instance.Exp = 0; // 重置经验值
        LevelUp();
        RandomColor();
        PlayerController.Instance.status.Respawn();
        State = GameState.Fight; // 设置游戏状态为战斗
    }

    public void CheckLevel()
    {
        if (State == GameState.Fight && PlayerController.Instance.Exp >= Math.Pow(2, Level))
        {
            LevelUp();
        }
    }

    private void RandomColor()
    {
        // 随机颜色
        var randomR = UnityEngine.Random.Range(0f, 1f);
        var randomG = UnityEngine.Random.Range(0f, 1 - randomR);
        var randomB = 1f - randomR - randomG;
        var color = PlayerController.Instance.PlayerColor = new Color(
            randomR,
            randomG,
            randomB
        );
        PlayerController.Instance.gameObject.GetComponent<SpriteRenderer>().material.DOColor(4 * color, 0.5f);
        GameObject.Find("Background/Background").GetComponent<SpriteRenderer>().material.DOVector(color * 0.025f, "_LineColor", 0.5f);
    }
    private void LevelUp()
    {
        Level += 1;
        var text = GameObject.Find("Canvas/Level").GetComponent<TMP_Text>();
        text.text = "Level " + Level;
        text.transform.DOPunchScale(Vector3.one * 0.2f, 0.5f, 10, 1f)
            .OnComplete(() => text.transform.localScale = Vector3.one);
        AudioManager.Instance.PlayEffect("SFX/LevelUp");
        MobSpawner.Instance.MobCount = Level; // 增加怪物数量
        PlayerController.Instance.shooter.ShootCD = 0.1f + 1f / Level;
        PlayerController.Instance.shooter.ShootCount = 1 + Level / 4;
        PlayerController.Instance.shooter.BulletDamage = Level * 10 + 30;
        MobSpawner.Instance.MobHealth = 100 + Level * 15; // 增加怪物生命值
        RandomColor();
    }
}
```

## 概念解析

### 枚举 Enum

你可以将枚举理解为一个可命名的值类型常量，它默认作为 int 类型存储。

特殊地，如果对枚举调用 ToString()，将得到枚举名而非枚举值。

相关链接：[枚举 Enum](https://learn.microsoft.com/zh-cn/dotnet/csharp/language-reference/builtin-types/enum)
