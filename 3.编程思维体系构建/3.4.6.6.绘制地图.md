# 6.ç»˜åˆ¶åœ°å›¾

ä½œä¸ºä¸€ä¸ª RPG æ¸¸æˆæ€ä¹ˆèƒ½æ²¡æœ‰åœ°å›¾å‘¢ï¼Œ*æ˜¯æ—¶å€™ç»˜åˆ¶åœ°å›¾äº†ï¼*

ç»˜åˆ¶åœ°å›¾çš„æœ€ä½³å·¥å…·å§‹ç»ˆæ˜¯ï¼šä¸€æ”¯é“…ç¬”å’Œä¸€å¼ çº¸ã€‚åŸºæœ¬åœ°å›¾ç”±**ä½ç½®**ï¼ˆçŸ©å½¢ï¼‰ç»„æˆï¼Œç”±é“è·¯ï¼ˆç®­å¤´ï¼‰è¿æ¥ã€‚æˆ‘ä»¬å·²ç»åœ¨ç¬¬ 3 ç« ä¸­åˆ›å»ºäº†ä½ç½®ï¼Œç°åœ¨æˆ‘ä»¬å°†å¼€å§‹æ·»åŠ é“è·¯ã€‚

åœ¨è™šæ‹Ÿä¸–ç•Œä¸­ï¼Œâ€œé“è·¯â€å¯èƒ½æ˜¯è¿æ¥ä¸¤ä¸ªä½ç½®çš„ä»»ä½•ä¸œè¥¿ï¼šä¸€æ¡è·¯ï¼Œä¸€æ‰‡é—¨ï¼Œæ²™æ¼ ä¸­ã€‚åŸºæœ¬ä¸Šï¼Œä¸€æ®µç»æ–‡å…·æœ‰ä»¥ä¸‹å±æ€§ï¼š

- èµ·ç‚¹ï¼ˆä½ç½®ï¼‰ã€‚
- ç›®æ ‡ï¼ˆä½ç½®ï¼‰ã€‚
- å™è¿°æ€§æè¿°ï¼Œä¾‹å¦‚â€œæ£®æ—å°å¾„â€ã€‚
- åœ¨ *go* å‘½ä»¤ä¸­å¾€å“ªé‡Œèµ°çš„æè¿°æ€§æ ‡è®°

è€ƒè™‘åˆ°è¿™äº›å±æ€§ï¼Œç¬¬ 4 ç« ä¸­å®šä¹‰çš„ç»“æ„å¯¹è±¡å°±éå¸¸é€‚åˆå­˜å‚¨é“è·¯äº†ã€‚äº‹å®ä¸Šï¼Œä¸€ä¸ªé“è·¯ä¸ä¸€ä¸ªé¡¹ç›®æˆ– NPC å¹¶æ²¡æœ‰å¤ªå¤§çš„ä¸åŒï¼Œå®ƒä½œä¸ºâ€œå¯è§å‡ºå£â€å­˜åœ¨äºæŸä¸ªä½ç½®ï¼ˆè¯¥ä½ç½®æ˜¯èµ·ç‚¹ï¼‰ã€‚å®ƒåªæ˜¯ä¸æŸäº›å‘½ä»¤çš„è¡Œä¸ºä¸åŒï¼Œç‰¹åˆ«æ˜¯å‘½ä»¤â€œgoâ€ï¼šåº”ç”¨äºé“è·¯ï¼Œ*go*å°†æ”¹å˜ç©å®¶çš„ä½ç½®ã€‚

```c
struct object {
   const char    *description;
   const char    *tag;
   struct object *location;
   struct object *destination;
};
```

æ³¨æ„ï¼š

- æ˜¾ç„¶ï¼Œ*ç›®çš„åœ°*åœ¨å¤§å¤šæ•°å…¶ä»–å¯¹è±¡ï¼ˆç‰©å“ï¼ŒNPCï¼‰ä¸­éƒ½æ²¡æœ‰ä½¿ç”¨
- é€šé“æ€»æ˜¯æœä¸€ä¸ªæ–¹å‘è¿è¡Œ;è¦åŒå‘è¿æ¥ä¸¤ä¸ªä½ç½®ï¼Œæˆ‘ä»¬æ€»æ˜¯å¿…é¡»åˆ›å»ºä¸¤ä¸ªå•ç‹¬çš„é€šé“ã€‚ä¹ä¸€çœ‹ï¼Œè¿™ä¼¼ä¹å¾ˆç¬¨æ‹™ï¼Œä½†å®ƒç¡®å®ç»™äº†æˆ‘ä»¬å¾ˆå¤§çš„çµæ´»æ€§æ¥å®Œå–„å‘½ä»¤â€œgoâ€çš„è¡Œä¸º
- åœ¨å¤§åœ°å›¾ä¸Šï¼Œä½ å¯èƒ½ä¼šå‘ç°æ‰‹åŠ¨åˆ›å»ºæ‰€æœ‰é€šé“å¾ˆä¹å‘³ã€‚æ‰€ä»¥ï¼Œæˆ‘å¼ºçƒˆå»ºè®®ä½ ä½¿ç”¨è‡ªå®šä¹‰å·¥å…·*ç”Ÿæˆ*åœ°å›¾ä¸­é‡å¤æ€§æ›´å¼ºçš„éƒ¨åˆ†ã€‚è¿™é‡Œä¸ä¼šä»‹ç»è¿™ä¸€ç‚¹ï¼Œä½†æ‚¨å¯èƒ½ä¼šåœ¨ç¬¬ 9 ç« ä¸­æ‰¾åˆ°ä¸€äº›çµæ„Ÿï¼Œæˆ‘ä»¬å°†åœ¨å…¶ä¸­è®¨è®ºè‡ªåŠ¨èƒœåœºã€‚

::: warning ğŸ¤” æ€è€ƒé¢˜ï¼šä¸ºä»€ä¹ˆåˆ›å»ºä¸¤ä¸ªé€šé“å¯ä»¥ä½¿æˆ‘ä»¬çš„ç¨‹åºæ›´åŠ çµæ´»ï¼Ÿ
:::

æ¥ä¸‹æ¥æˆ‘ä»¬å°†å±•å¼€å¯¹è±¡æ•°ç»„

## object.h

```c
typedef struct object {
   const char    *description;
   const char    *tag;
   struct object *location;
   struct object *destination;
} OBJECT;

extern OBJECT objs[];

#define field      (objs + 0)   //æ˜¯ä¸æ˜¯è§‰å¾—è¿™ä¸ªå¾ˆç†Ÿæ‚‰
#define cave       (objs + 1)
#define silver     (objs + 2)
#define gold       (objs + 3)
#define guard      (objs + 4)
#define player     (objs + 5)
#define intoCave   (objs + 6)
#define exitCave   (objs + 7)

#define endOfObjs  (objs + 8)
```

## object.c

```c
#include <stdio.h>
#include "object.h"

OBJECT objs[] = {
   {"an open field"  , "field"   , NULL , NULL  },
   {"a little cave"  , "cave"    , NULL , NULL  },
   {"a silver coin"  , "silver"  , field, NULL  },
   {"a gold coin"    , "gold"    , cave , NULL  },
   {"a burly guard"  , "guard"   , field, NULL  },
   {"yourself"       , "yourself", field, NULL  },
   {"a cave entrance", "entrance", field, cave  },
   {"an exit"        , "exit"    , cave , field }
};
```

æˆ‘ä»¬å°†åœ¨ *misc.c* ä¸­æ·»åŠ ä¸€ä¸ªå°çš„å¸®åŠ©å‡½æ•°ï¼Œä»¥ç¡®å®šä¸¤ä¸ªç»™å®šä½ç½®ä¹‹é—´æ˜¯å¦å­˜åœ¨é€šé“ã€‚

## misc.h

```c
extern OBJECT *getPassage(OBJECT *from, OBJECT *to);
extern OBJECT *actorHere(void);
extern int listObjectsAtLocation(OBJECT *location);
```

## misc.c

```c
#include <stdio.h>
#include "object.h"

OBJECT *getPassage(OBJECT *from, OBJECT *to)
{
   if (from != NULL && to != NULL)
   {
      OBJECT *obj;
      for (obj = objs; obj < endOfObjs; obj++)   //å¯»æ‰¾ç‰©å“ä¹‹é—´æ˜¯å¦å…·æœ‰é€šé“
      {
         if (obj->location == from && obj->destination == to)
         {
            return obj;  //æ‰¾åˆ°äº†
         }
      }
   }
   return NULL;//æ‰¾ä¸åˆ°
}

OBJECT *actorHere(void)
{
   OBJECT *obj;
   for (obj = objs; obj < endOfObjs; obj++)
   {
      if (obj->location == player->location && obj == guard)
      {
         return obj;
      }
   }
   return NULL;
}

int listObjectsAtLocation(OBJECT *location)
{
   int count = 0;
   OBJECT *obj;
   for (obj = objs; obj < endOfObjs; obj++)
   {
      if (obj != player && obj->location == location)
      {
         if (count++ == 0)
         {
            printf("You see:\n");
         }
         printf("%s\n", obj->description);
      }
   }
   return count;
}
```

æˆ‘ä»¬å°†åœ¨å‘½ä»¤â€œgoâ€çš„å®ç°ä¸­ä½¿ç”¨æ–°åŠŸèƒ½*getPassage*æ¥ç¡®å®šæ˜¯å¦å­˜åœ¨å¯ä»¥å°†ç©å®¶å¸¦åˆ°æ‰€éœ€ä½ç½®çš„é€šé“ã€‚

## location.h

```c
extern void executeLook(const char *noun);
extern void executeGo(const char *noun);
```

## location.c

```c
#include <stdio.h>
#include <string.h>
#include "object.h"
#include "misc.h"
#include "noun.h"

void executeLook(const char *noun)
{
   if (noun != NULL && strcmp(noun, "around") == 0)
   {
      printf("You are in %s.\n", player->location->description);
      listObjectsAtLocation(player->location);
   }
   else
   {
      printf("I don't understand what you want to see.\n");
   }
}

void executeGo(const char *noun)
{
   OBJECT *obj = getVisible("where you want to go", noun);
   if (obj == NULL)
   {
      // already handled by getVisible
   }
   else if (getPassage(player->location, obj) != NULL)
   //go åªä¼šåœ¨æœ‰åœ°æ–¹çš„æ—¶å€™æ‰ä¼šè¿è¡Œèµ·æ¥
   {
      printf("OK.\n");
      player->location = obj;
      executeLook("around");
   }
   else if (obj->location != player->location)
   {
      printf("You don't see any %s here.\n", noun);
   }
   else if (obj->destination != NULL)
   {
      printf("OK.\n");
      player->location = obj->destination;
      executeLook("around");
   }
   else
   {
      printf("You can't get much closer than this.\n");
   }
}
```

æˆ‘ä»¬è¿˜å°†ä½¿ç”¨æ–°åŠŸèƒ½*getPassage*æ¥ç¡®å®šä»ç©å®¶ç«™ç«‹çš„ä½ç½®æ˜¯å¦å¯ä»¥çœ‹åˆ°æŸä¸ªä½ç½®ã€‚æœªé€šè¿‡é€šé“è¿æ¥åˆ°å½“å‰ä½ç½®çš„ä½ç½®ä¸è¢«è§†ä¸ºå¯è§ã€‚

## noun.h

```c
extern OBJECT *getVisible(const char *intention, const char *noun);
extern OBJECT *getPossession(OBJECT *from, const char *verb, const char *noun);
```

## noun.c

```c
#include <stdbool.h>
#include <stdio.h>
#include <string.h>
#include "object.h"
#include "misc.h"

static bool objectHasTag(OBJECT *obj, const char *noun)
{
   return noun != NULL && *noun != '\0' && strcmp(noun, obj->tag) == 0;
}

static OBJECT *getObject(const char *noun)
{
   OBJECT *obj, *res = NULL;
   for (obj = objs; obj < endOfObjs; obj++)
   {
      if (objectHasTag(obj, noun))
      {
         res = obj;
      }
   }
   return res;
}

OBJECT *getVisible(const char *intention, const char *noun)
{
   OBJECT *obj = getObject(noun);
   
   if (obj == NULL)
   {
      printf("I don't understand %s.\n", intention);
   }
   else if (!(obj == player ||
              obj == player->location ||
              obj->location == player ||
              obj->location == player->location ||
              getPassage(player->location, obj) != NULL ||   //æ£€æŸ¥ä¸¤ä¸ªä½ç½®æ˜¯å¦ç›¸é‚»
              (obj->location != NULL &&
               (obj->location->location == player ||
                obj->location->location == player->location))))
   {
      printf("You don't see any %s here.\n", noun);
      obj = NULL;
   }
   return obj;
}

OBJECT *getPossession(OBJECT *from, const char *verb, const char *noun)
{
   OBJECT *obj = NULL;
   if (from == NULL)
   {
      printf("I don't understand who you want to %s.\n", verb);
   }
   else if ((obj = getObject(noun)) == NULL)
   {
      printf("I don't understand what you want to %s.\n", verb);
   }
   else if (obj == from)
   {
      printf("You should not be doing that to %s.\n", obj->description);
      obj = NULL;
   }
   else if (obj->location != from)
   {
      if (from == player)
      {
         printf("You are not holding any %s.\n", noun);
      }
      else
      {
         printf("There appears to be no %s you can get from %s.\n",
                noun, from->description);
      }
      obj = NULL;
   }
   return obj;
}
```

æ˜¾ç„¶ï¼Œæ­¤ç¤ºä¾‹ä¸­çš„åœ°å›¾æ˜¯å¾®ä¸è¶³é“çš„ï¼šåªæœ‰ä¸¤ä¸ªä½ç½®ï¼Œå¹¶ä¸”å®ƒä»¬åœ¨ä¸¤ä¸ªæ–¹å‘ä¸Šéƒ½è¿æ¥åœ¨ä¸€èµ·ã€‚ç¬¬ 12 ç« å°†å¢åŠ ç¬¬ä¸‰ä¸ªåœ°ç‚¹ã€‚

::: warning ğŸ¤” æ€è€ƒé¢˜ï¼š
ä½ èƒ½å¦ç»˜åˆ¶ä¸€å¼ æ›´ç²¾ç»†çš„åœ°å›¾ï¼Œå¹¶å°†å…¶å˜æˆå¯¹è±¡åˆ—è¡¨ï¼ˆä½ç½®å’Œé€šé“ï¼‰

æ³¨ï¼šä¸ç”¨å½“æˆä»»åŠ¡ï¼Œè‡ªè¡Œå®éªŒå³å¯

:::

è¾“å‡ºæ ·ä¾‹

Welcome to Little Cave Adventure.
You are in an open field.
You see:
a silver coin
a burly guard
a cave entrance

--> go entrance
OK.
You are in a little cave.
You see:
a gold coin
an exit

--> go exit
OK.
You are in an open field.
You see:
a silver coin
a burly guard
a cave entrance

--> go cave
OK.
You are in a little cave.
You see:
a gold coin
an exit

--> quit

Bye!
