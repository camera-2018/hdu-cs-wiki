# 10.å¢æ·»å±æ€§

æˆ‘ä»¬åœ¨ç¬¬ 4 ç« ä¸­ä»‹ç» object æ—¶ï¼Œå®ƒä»¬åªæœ‰ä¸‰ä¸ªå±æ€§ã€‚

åœ¨ç¬¬ 6 ç« ä¸­ï¼Œæˆ‘ä»¬å¢åŠ äº†ç¬¬å››ä¸ªã€‚è¿™ä»–å¦ˆå¤ªå°‘äº†ï¼

ä¸ºäº†åœ¨æˆ‘ä»¬çš„å†’é™©ä¸­åŠ å…¥æ›´å¤šç»†èŠ‚ï¼Œæˆ‘ä»¬éœ€è¦æ›´å¤šçš„å±æ€§ã€‚ä¸‹é¢æ˜¯ä¸€äº›ç¤ºä¾‹ã€‚

1. ç¯é¡¾å››å‘¨è¿™ä¸ªå‘½ä»¤å¯ä»¥ç»™å‡ºç©å®¶ä½ç½®çš„å…¨å±€æè¿°ï¼ŒåŒ…æ‹¬åœ¨é‚£é‡Œçš„ç‰©å“ã€NPC å’Œå…¶ä»–å¯¹è±¡çš„åˆ—è¡¨ã€‚å¾ˆå¤šå†’é™©æ´»åŠ¨éƒ½éœ€è¦ç©å®¶å¯¹è¿™äº›å¯¹è±¡è¿›è¡ŒæŸ¥è¯¢ï¼Œä»è€Œæ­ç¤ºå‡ºåœ¨æ¸¸æˆä¸­è·å¾—è¿›å±•æ‰€éœ€è¦çš„æŸäº›çº¿ç´¢ï¼Œæˆ–è€…ç®€å•åœ°æå‡æ¸¸æˆçš„æ°›å›´ã€‚æˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªå¯¹æ¯ä¸ªå¯¹è±¡éƒ½æœ‰è¯¦ç»†è¯´æ˜çš„å±æ€§ç»†èŠ‚ï¼ŒåŠ ä¸Šä¸€ä¸ªä¸åŒ…å«å…¶ä»–å¯¹è±¡çš„å¯¹è±¡ä¸€èµ·ä½¿ç”¨çš„å±æ€§å†…å®¹ã€‚
2. å¦‚æœç©å®¶å¼€å§‹ä¸€æ®µè¯æ—¶ï¼Œå“åº”æ€»æ˜¯â€œOKâ€å’Œæ–°ä½ç½®çš„æè¿°ã€‚è¿™ä¼¼ä¹æœ‰ç‚¹æ²‰é—·ã€‚æ‰€ä»¥ï¼Œä¸ºæ¯ä¸ªæ®µè½æä¾›è‡ªå·±çš„è‡ªå®šä¹‰æ¶ˆæ¯ä¼šæ›´å¥½ã€‚æˆ‘ä»¬å°†æ·»åŠ ä¸€ä¸ªå±æ€§ textGo æ¥ä¿å­˜æ­¤æ¶ˆæ¯ã€‚
3. æœ‰äº›é€šé“å¯èƒ½æ˜¯ç‰¹æ®Šè®¾å®šçš„ï¼Œæ¯”å¦‚è¯´ä¼ é€é—¨ï¼Œé™·é˜±ç­‰ç­‰ã€‚

ä¸¾ä¸ªä¾‹å­ï¼Œä¸€æ¡æ—é“å¯èƒ½éšè—ç€é™·é˜±ã€‚è™½ç„¶é€šé“ä¼¼ä¹ä»ä½ç½® A é€šå‘ä½ç½® Bï¼Œä½†å®é™…ä¸Šç»ˆç‚¹æ˜¯ä½ç½® Cï¼Œå³æ‰è¿›å‘äº†ã€‚

å‡è®¾æˆ‘ä»¬çš„æ´å£è¢«è­¦å«æŒ¡ä½äº†ã€‚ç©å®¶å°±è¿‡ä¸å»ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•åœ°å°†é€šé“çš„*ç›®çš„åœ°*æ›´æ”¹ä¸ºç»ˆç‚¹ä½ç½®ï¼ˆæˆ– *NULL*ï¼‰ï¼Œä½†è¿™ä¼šå¯¼è‡´å¯¹*è¯¸å¦‚ go cave å’Œ look cave* è¿™æ ·çš„å‘½ä»¤åšå‡ºä¸æ­£ç¡®çš„å›åº”ï¼šâ€œä½ åœ¨è¿™é‡Œçœ‹ä¸åˆ°ä»»ä½•æ´ç©´ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªå°†é€šé“çš„å®é™…ç»ˆç‚¹å’Œè™šå‡ç»ˆç‚¹åˆ†å¼€çš„å•ç‹¬å±æ€§ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†å¼•å…¥ä¸€ä¸ªå±æ€§ prospect æ¥è¡¨ç¤ºåè€…ã€‚

1. åœ¨è®¸å¤šå†’é™©ä¸­ï¼Œç©å®¶ä»¥åŠæ¸¸æˆä¸­çš„ NPC åœ¨æºå¸¦é‡æ–¹é¢å—åˆ°é™åˆ¶ã€‚ç»™æ¯ä»¶ç‰©å“ä¸€ä¸ªé‡é‡ï¼Œè§’è‰²åº“å­˜ä¸­æ‰€æœ‰ç‰©å“çš„æ€»é‡é‡ä¸åº”è¶…è¿‡è¯¥è§’è‰²æ‰€èƒ½æ‰¿è½½çš„æœ€å¤§é‡é‡ã€‚å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç»™ä¸€ä¸ªç‰©ä½“ä¸€ä¸ªéå¸¸é«˜çš„é‡é‡ï¼Œä½¿å®ƒä¸å¯ç§»åŠ¨ï¼ˆä¸€æ£µæ ‘ï¼Œä¸€åº§æˆ¿å­ï¼Œä¸€åº§å±±ï¼‰ã€‚
2. RPG å¼çš„å†’é™©æ¸¸æˆéœ€è¦è§’è‰²çš„æ•´ä¸ªå±æ€§èŒƒå›´ ( ç©å®¶ä¸éç©å®¶ )ï¼Œä¾‹å¦‚ HPã€‚HP ä¸ºé›¶çš„å¯¹è±¡è¦ä¹ˆæ­»äº†ï¼Œè¦ä¹ˆæ ¹æœ¬ä¸æ˜¯è§’è‰²ã€‚

æˆ‘ä»¬åœ¨ object.txt ä¸­å®šä¹‰äº†ä¸ƒä¸ªæ–°å±æ€§ï¼š

```c
#include <stdio.h>
#include "object.h"

typedef struct object {
   const char    *description;
   const char   **tags;
   struct object *location;
   struct object *destination;
   struct object *prospect;
   const char    *details;
   const char    *contents;
   const char    *textGo;
   int            weight;
   int            capacity;
   int            health;
} OBJECT;

extern OBJECT objs[];

- field
     description "an open field"
     tags        "field"
     details     "The field is a nice and quiet place under a clear blue sky."
     capacity    9999

- cave
     description "a little cave"
     tags        "cave"
     details     "The cave is just a cold, damp, rocky chamber."
     capacity    9999

- silver
     description "a silver coin"
     tags        "silver", "coin", "silver coin"
     location    field
     details     "The coin has an eagle on the obverse."
     weight      1
     //å¦‚æœä½ è§‰å¾—ä¸åˆç†ï¼Œå¯ä»¥è‡ªå·±æ›´æ”¹

- gold
     description "a gold coin"
     tags        "gold", "coin", "gold coin"
     location    cave
     details     "The shiny coin seems to be a rare and priceless artefact."
     weight      1

- guard
     description "a burly guard"
     tags        "guard", "burly guard"
     location    field
     details     "The guard is a really big fellow."
     contents    "He has"
     health      100
     capacity    20

- player
     description "yourself"
     tags        "yourself"
     location    field
     details     "You would need a mirror to look at yourself."
     contents    "You have"
     health      100
     capacity    20

- intoCave
     description "a cave entrance to the east"
     tags        "east", "entrance"
     location    field
     prospect    cave
     details     "The entrance is just a narrow opening in a small outcrop."
     textGo      "The guard stops you from walking into the cave."

- exitCave
     description "an exit to the west"
     tags        "west", "exit"
     location    cave
     destination field
     details     "Sunlight pours in through an opening in the cave's wall."
     textGo      "You walk out of the cave."

- wallField
     description "dense forest all around"
     tags        "west", "north", "south", "forest"
     location    field
     details     "The field is surrounded by trees and undergrowth."
     textGo      "Dense forest is blocking the way."

- wallCave
     description "solid rock all around"
     tags        "east", "north", "south", "rock"
     location    cave
     details     "Carved in stone is a secret password 'abccb'."
     textGo      "Solid rock is blocking the way."
```

æ³¨æ„ï¼štextGo ä¸ä»…å¯¹é€šé“å¯¹è±¡æœ‰ç”¨ï¼Œè€Œä¸”å¯¹éé€šé“å¯¹è±¡ä¹Ÿæœ‰ç”¨ ( åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä»¥åæˆ‘ä»¬å°†ä»‹ç»â€œå¢™â€è¿™ä¸ªæ¦‚å¿µ)

::: warning ğŸ¤” æ€è€ƒé¢˜ï¼šä½ èƒ½å¦è‡ªè¡Œå®ç°ä¸Šè¿°ä¼ªä»£ç ï¼Ÿ
:::

ç°åœ¨ï¼Œæˆ‘ä»¬å·²ç»å¯ä»¥ä½¿ç”¨æ–°å±æ€§ (å¦‚æœä½ å®Œæˆäº†ä¸Šé¢çš„æ€è€ƒé¢˜),**details** ç”¨äºæ–°è¯†åˆ«çš„å‘½ä»¤*å¤–è§‚`<object>`*ï¼Œ**textGo** åœ¨æˆ‘ä»¬çš„å‘½ä»¤ *go* å®ç°ä¸­æ›¿æ¢å›ºå®šæ–‡æœ¬*â€œOK*â€ã€‚

## location.c

```c
#include <stdbool.h>
#include <stdio.h>
#include <string.h>
#include "object.h"
#include "misc.h"
#include "noun.h"

void executeLook(const char *noun)
{
   if (noun != NULL && strcmp(noun, "around") == 0)
   {
      printf("You are in %s.\n", player->location->description);
      listObjectsAtLocation(player->location);
   }
   else
   {
      OBJECT *obj = getVisible("what you want to look at", noun);
      switch (getDistance(player, obj))
      {
      case distHereContained:
         printf("Hard to see, try to get it first.\n");
         break;
      case distOverthere:
         printf("Too far away, move closer please.\n");
         break;
      case distNotHere:
         printf("You don't see any %s here.\n", noun);
         break;
      case distUnknownObject:
         // already handled by getVisible
         break;
      default:
         printf("%s\n", obj->details);
         listObjectsAtLocation(obj);
      }
   }
}

static void movePlayer(OBJECT *passage)
{
   printf("%s\n", passage->textGo);
   if (passage->destination != NULL)
   {
      player->location = passage->destination;
      printf("\n");
      executeLook("around");
   }
}

void executeGo(const char *noun)
{
   OBJECT *obj = getVisible("where you want to go", noun);
   switch (getDistance(player, obj))
   {
   case distOverthere:
      movePlayer(getPassage(player->location, obj));
      break;
   case distNotHere:
      printf("You don't see any %s here.\n", noun);
      break;
   case distUnknownObject:
      // already handled by getVisible
      break;
   default:
      movePlayer(obj);
   }
}
```

å±æ€§æƒé‡å’Œå®¹é‡ä¸€èµ·æˆä¸ºä¸èƒ½å°†æŸäº›å¯¹è±¡ç§»åŠ¨åˆ°å‘¨å›´çš„å¯èƒ½åŸå› ã€‚è€Œ HP æ£€æŸ¥ä»£æ›¿äº†è§’è‰²çš„ç¡¬ç¼–ç ç™½åå•ã€‚

## move.c

```c
#include <stdbool.h>
#include <stdio.h>
#include "object.h"
#include "misc.h"

static int weightOfContents(OBJECT *container)
{
   int sum = 0;
   OBJECT *obj;
   for (obj = objs; obj < endOfObjs; obj++)
   {
      if (isHolding(container, obj)) sum += obj->weight;
   }
   return sum;
}

static void describeMove(OBJECT *obj, OBJECT *to)
{
   if (to == player->location)
   {
      printf("You drop %s.\n", obj->description);
   }
   else if (to != player)
   {
      printf(to->health > 0 ? "You give %s to %s.\n" : "You put %s in %s.\n",
             obj->description, to->description);
   }
   else if (obj->location == player->location)
   {
      printf("You pick up %s.\n", obj->description);
   }
   else
   {
      printf("You get %s from %s.\n",
             obj->description, obj->location->description);
   }
}

void moveObject(OBJECT *obj, OBJECT *to)
{
   if (obj == NULL)
   {
      // already handled by getVisible or getPossession
   }
   else if (to == NULL)
   {
      printf("There is nobody here to give that to.\n");
   }
   else if (obj->weight > to->capacity)
   {
      printf("That is way too heavy.\n");
   }
   else if (obj->weight + weightOfContents(to) > to->capacity)
   {
      printf("That would become too heavy.\n");
   }
   else
   {
      describeMove(obj, to);
      obj->location = to;
   }
}
```

è¿™é‡Œè¿˜æœ‰ä¸€ä¸ªæ¨¡å—å¯ä»¥ä½¿ç”¨ HP æ¥è¯†åˆ«è§’è‰²ã€‚

## inventory.c

```c
#include <stdbool.h>
#include <stdio.h>
#include "object.h"
#include "misc.h"
#include "noun.h"
#include "move.h"

void executeGet(const char *noun)
{
   OBJECT *obj = getVisible("what you want to get", noun);
   switch (getDistance(player, obj))
   {
   case distSelf:
      printf("You should not be doing that to yourself.\n");
      break;
   case distHeld:
      printf("You already have %s.\n", obj->description);
      break;
   case distOverthere:
      printf("Too far away, move closer please.\n");
      break;
   case distUnknownObject:
      // already handled by getVisible
      break;
   default:
      if (obj->location != NULL && obj->location->health > 0)
      {
         printf("You should ask %s nicely.\n", obj->location->description);
      }
      else
      {
         moveObject(obj, player);
      }
   }
}

void executeDrop(const char *noun)
{
   moveObject(getPossession(player, "drop", noun), player->location);
}

void executeAsk(const char *noun)
{
   moveObject(getPossession(actorHere(), "ask", noun), player);
}

void executeGive(const char *noun)
{
   moveObject(getPossession(player, "give", noun), actorHere());
}

void executeInventory(void)
{
   if (listObjectsAtLocation(player) == 0)
   {
      printf("You are empty-handed.\n");
   }
}
```

::: warning ğŸ¤” æ€è€ƒé¢˜ï¼šä»”ç»†è§‚å¯Ÿè¿™æ®µä»£ç ï¼Œçœ‹çœ‹ä¸ä½ å†™çš„æœ‰ä½•ä¸åŒï¼Ÿ
:::

æƒé‡æ£€æŸ¥åˆ©ç”¨äº†æ–°åŠŸèƒ½ *weightOfContentsï¼Œ*å®ƒå°†åœ¨*misc.c*ä¸­å®ç°ã€‚åœ¨åŒä¸€æ¨¡å—ä¸­ï¼Œæˆ‘ä»¬è¿˜å¯¹ä¸€äº›ç°æœ‰å‡½æ•°è¿›è¡Œäº†ä¿®æ”¹ï¼Œä»¥æ”¯æŒæœ€åå‡ ä¸ªå±æ€§ã€‚

å±æ€§å†…å®¹å°†æ›¿æ¢å›ºå®šæ–‡æœ¬*â€œYou seeâ€ã€‚*åœ¨åˆ—å‡ºç©å®¶çš„åº“å­˜æ—¶ï¼ŒåŸå§‹æ–‡æœ¬å·²ç»æœ‰ç‚¹å¥‡æ€ªäº†ï¼Œä½†æ˜¯ç°åœ¨å‡½æ•°*listObjectsAtLocation*ç”¨äºæ˜¾ç¤ºä»»ä½•å¯èƒ½å¯¹è±¡çš„å†…å®¹ï¼ˆè¯·å‚é˜…ä¸Šé¢çš„å‡½æ•°*expertLook*ï¼‰ï¼Œæˆ‘ä»¬çœŸçš„éœ€è¦ä¸€äº›æ›´çµæ´»çš„ä¸œè¥¿ã€‚

åœ¨å‡½æ•° *getPassage* ä¸­æˆ‘ä»¬å°†å±æ€§*ç›®æ ‡*æ›¿æ¢ä¸º prospectï¼Œå¹¶æ”¹è¿›*å¯¹æ‰€æœ‰*å‘½ä»¤ï¼ˆè€Œä¸ä»…ä»…æ˜¯ *go* and *look*ï¼‰çš„å“åº”ï¼Œè¿™äº›å‘½ä»¤åº”ç”¨äºä½äºâ€œéšè—é€šé“â€å¦ä¸€ç«¯çš„ä½ç½®ã€‚

## misc.h

```c
typedef enum {
   distSelf,
   distHeld,
   distHeldContained,
   distLocation,
   distHere,
   distHereContained,
   distOverthere,
   distNotHere,
   distUnknownObject
} DISTANCE;

extern bool isHolding(OBJECT *container, OBJECT *obj);
extern OBJECT *getPassage(OBJECT *from, OBJECT *to);
extern DISTANCE getDistance(OBJECT *from, OBJECT *to);
extern OBJECT *actorHere(void);
extern int listObjectsAtLocation(OBJECT *location);
```

## misc.c

```c
#include <stdbool.h>
#include <stdio.h>
#include "object.h"
#include "misc.h"

bool isHolding(OBJECT *container, OBJECT *obj)
{
   return obj != NULL && obj->location == container;
}

OBJECT *getPassage(OBJECT *from, OBJECT *to)
{
   if (from != NULL && to != NULL)
   {
      OBJECT *obj;
      for (obj = objs; obj < endOfObjs; obj++)
      {
         if (isHolding(from, obj) && obj->prospect == to)
         {
            return obj;
         }
      }
   }
   return NULL;
}

DISTANCE getDistance(OBJECT *from, OBJECT *to)
{
   return to == NULL                               ? distUnknownObject :
          to == from                               ? distSelf :
          isHolding(from, to)                      ? distHeld :
          isHolding(to, from)                      ? distLocation :
          isHolding(from->location, to)            ? distHere :
          isHolding(from, to->location)            ? distHeldContained :
          isHolding(from->location, to->location)  ? distHereContained :
          getPassage(from->location, to) != NULL   ? distOverthere :
                                                     distNotHere;
}

OBJECT *actorHere(void)
{
   OBJECT *obj;
   for (obj = objs; obj < endOfObjs; obj++)
   {
      if (isHolding(player->location, obj) && obj != player &&
          obj->health > 0)
      {
         return obj;
      }
   }
   return NULL;
}

int listObjectsAtLocation(OBJECT *location)
{
   int count = 0;
   OBJECT *obj;
   for (obj = objs; obj < endOfObjs; obj++)
   {
      if (obj != player && isHolding(location, obj))
      {
         if (count++ == 0)
         {
            printf("%s:\n", location->contents);
         }
         printf("%s\n", obj->description);
      }
   }
   return count;
}
```

::: warning ğŸ¤” æ€è€ƒé¢˜ï¼š
ä¸ºä»€ä¹ˆä¸Šé¢çš„ getPassage å‡½æ•°ä½¿ç”¨äº†å‡½æ•°æŒ‡é’ˆè¿™ç§è¯­æ³•ï¼Ÿ

å‡½æ•°æŒ‡é’ˆå’ŒæŒ‡é’ˆå‡½æ•°æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
:::

ä¸ºäº†ä½¿æ•´ä¸ªç”»é¢å®Œæ•´ï¼Œæœ€å¥½æ‰©å±•å‰é¢ç”Ÿæˆçš„åœ°å›¾ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨è™šçº¿è¡¨ç¤ºâ€œæ˜æ˜¾â€çš„é€šé“ã€‚

```awk
BEGIN     { print "digraph map {"; }
/^- /     { outputEdges(); delete a; }
/^[ \t]/  { a[$1] = $2; }
END       { outputEdges(); print "}"; }

function outputEdges()
{
   outputEdge(a["location"], a["destination"], "");
   outputEdge(a["location"], a["prospect"], " [style=dashed]");
}

function outputEdge(from, to, style)
{
   if (from && to) print "\t" from " -> " to style;
}
```

æ³¨æ„ï¼š

- å°½é‡ä¸è¦å¤ªæ‹…å¿ƒæµªè´¹ä»…åœ¨æŸäº›ç±»å‹çš„å¯¹è±¡ä¸­ä½¿ç”¨çš„å±æ€§ä¸Šçš„å†…å­˜ç©ºé—´ï¼ˆä¾‹å¦‚ï¼Œ*textGo*ä»…ç”¨äºé€šé“ï¼‰ï¼Œæˆ–è€…è®¸å¤šé‡å¤çš„å­—ç¬¦ä¸²æ–‡æœ¬ã€‚
- ä¸ºäº†æ¼”ç¤ºå±æ€§ prospect çš„ä½¿ç”¨ï¼Œæˆ‘ä»¬ä½¿æ´ç©´æ— æ³•è®¿é—®ã€‚å½“æ‚¨æŸ¥çœ‹æ–°*åœ°å›¾æ—¶ï¼Œ*è¿™ä¸€ç‚¹ç«‹å³å˜å¾—å¾ˆæ˜æ˜¾ã€‚è¿›å…¥æ´ç©´çš„ç®­å¤´æ˜¯è™šçº¿çš„ï¼Œè¿™æ„å‘³ç€è¿™æ˜¯ä¸€ä¸ªè™šå‡çš„é€šé“ï¼Œä½†ä¸æ˜¯å®é™…çš„é€šé“ã€‚è¯·æ”¾å¿ƒï¼Œæ´ç©´å°†åœ¨ä¸‹ä¸€ç« é‡æ–°å¼€æ”¾ã€‚
- è¯·æ³¨æ„ï¼Œæ›´è¯¦ç»†çš„æè¿°å¾€å¾€éœ€è¦ä¸€ä¸ªæ›´å¤§çš„å­—å…¸ï¼ˆæ›´å¤šçš„å¯¹è±¡ï¼Œæ›´å¤šçš„æ ‡ç­¾ï¼‰ã€‚ä¾‹å¦‚ï¼Œå‘½ä»¤ look silver coin ç°åœ¨è¿”å› "è¯¥ç¡¬å¸çš„æ­£é¢æœ‰ä¸€åªé¹°"ã€‚ç©å®¶é€šè¿‡è¾“å…¥ä¸€ä¸ªå‘½ä»¤ look eagle æ¥æŸ¥çœ‹é“¶å¸ï¼Œä½†ç¨‹åºå¹¶ä¸çŸ¥é“é¹°æ˜¯ä»€ä¹ˆæ„æ€ (æ˜¾ç„¶è¿™æ ·å­æ˜¯ä¸è¡Œçš„)ã€‚

è¾“å‡ºæ ·ä¾‹

Welcome to Little Cave Adventure.
You are in an open field.
You see:
a silver coin
a burly guard
a cave entrance to the east
dense forestall around

--> look guard
The guard is a really big fellow.

--> get guard
That is way too heavy.

--> get coin
You pick up a silver coin.

--> inventory
You have:
a silver coin

--> give coin
You give a silver coin to a burly guard.

--> look guard
The guard is a really big fellow.
He has:
a silver coin

--> go cave
The guard stops you from walking into the cave.

--> go north
Dense forest is blocking the way.

--> quit

Bye!
